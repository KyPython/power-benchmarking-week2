"use strict";(()=>{var e={};e.id=907,e.ids=[907],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},5351:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>m});var s={};o.r(s),o.d(s,{POST:()=>d});var r=o(49303),n=o(88716),a=o(60670),i=o(87070),c=o(84770),u=o(63009);async function d(e){try{let{email:t,plan:o="premium",checkoutId:s}=await e.json();if(!t)return i.NextResponse.json({error:"Email is required"},{status:400});let r=function(){let e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",t="";for(let o=0;o<8;o++)4===o&&(t+="-"),t+=e.charAt(Math.floor(Math.random()*e.length));return t}(),n="pbs_"+(0,c.randomBytes)(32).toString("hex"),a=Date.now()+9e5;return u.deviceCodes.set(r.toUpperCase(),{email:t,plan:o,expiresAt:a,activated:!1,activatedAt:null,token:n,checkoutId:s}),console.log(`[DeviceCodes] Created code ${r} for ${t}, plan: ${o}`),i.NextResponse.json({code:r,expiresAt:a,verificationUrl:`https://power-benchmarking-week2.vercel.app//activate?code=${r}`,instructions:"Visit the verification URL and click to confirm activation"})}catch(e){return console.error("[DeviceCodes] Error creating code:",e),i.NextResponse.json({error:"Failed to create activation code"},{status:500})}}let l=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/device-codes/route",pathname:"/api/device-codes",filename:"route",bundlePath:"app/api/device-codes/route"},resolvedPagePath:"/Users/ky/power-benchmarking-week2/app/api/device-codes/route.js",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:m,serverHooks:h}=l,f="/api/device-codes/route";function v(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:m})}},63009:(e,t,o)=>{o.r(t),o.d(t,{POST:()=>g,deviceCodes:()=>n,processedEvents:()=>a,purchaseRecords:()=>i});var s=o(87070),r=o(84770);let n=new Map,a=new Map,i=new Map;function c(){let e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",t="";for(let o=0;o<8;o++)4===o&&(t+="-"),t+=e.charAt(Math.random()*e.length);return t}function u(){return"pbs_"+(0,r.randomBytes)(32).toString("hex")}function d(e,t){let o={eventId:e,type:t.type,customerEmail:t.customer_email||t.customer?.email,checkoutId:t.id,productName:t.product?.name,amount:t.amount,currency:t.currency,status:t.status,processedAt:new Date().toISOString()};return i.set(e,o),console.log("[Purchase] Stored record:",e,t.type),o}async function l(e,t){if(!e||!t)return!1;try{let o=await fetch(`https://api.polar.sh/v1/subscriptions/${e}`,{headers:{Authorization:`Bearer ${t}`,Accept:"application/json"},timeout:1e4});if(!o.ok)return console.log("[Verify] Failed to verify subscription:",o.status),!1;let s=await o.json();return"active"===s.status}catch(e){return console.log("[Verify] Error verifying subscription:",e.message),!1}}async function p(e,t){let o=e.id,r=e.customer_email||e.customer?.email,i=e.product?.name||"Premium";if(a.has(o))return console.log("[Checkout] Already processed:",o),s.NextResponse.json({received:!0,idempotent:!0,existingCode:a.get(o)});if(!r)return console.log("[Checkout] No customer email, skipping"),s.NextResponse.json({error:"No customer email"},{status:400});if("completed"!==e.status&&"paid"!==e.status)return console.log("[Checkout] Payment not completed:",e.status),s.NextResponse.json({received:!0,skipped:!0,reason:`Payment status: ${e.status}`});let l=c(),p=u(),m=Date.now()+9e5;n.set(l,{email:r,plan:"premium",expiresAt:m,activated:!1,activatedAt:null,token:p,checkoutId:o,productName:i,subscriptionId:e.subscription_id}),a.set(o,l),d(o,{type:"checkout.completed",id:o,customer_email:r,product:{name:i},amount:e.amount,currency:e.currency,status:e.status,subscription_id:e.subscription_id}),console.log("[Checkout] Created activation:",l,"for",r);try{let e="https://power-benchmarking-week2.vercel.app/",t=`${e}/activate?code=${l}`;await fetch(`${e}/api/send-activation-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,code:l,activationUrl:t,productName:i})})}catch(e){console.log("[Checkout] Email send failed:",e.message)}return s.NextResponse.json({success:!0,checkoutId:o,activationCode:l,message:"Activation code created and email sent"})}async function m(e,t){let o=e.id,r=e.customer?.email;if(a.has(o))return s.NextResponse.json({received:!0,idempotent:!0});if(!r)return s.NextResponse.json({received:!0});let i=await l(o,t);if(!i&&"active"!==e.status)return console.log("[Subscription] Not active, skipping"),s.NextResponse.json({received:!0,skipped:!0});let p=c(),m=u();return n.set(p,{email:r,plan:i?"premium":"trial",expiresAt:Date.now()+9e5,activated:!1,activatedAt:null,token:m,subscriptionId:o,productName:e.product?.name}),a.set(o,p),d(o,{type:"subscription.created",id:o,customer_email:r,product:e.product,status:e.status}),console.log("[Subscription] Created for",r,":",p),s.NextResponse.json({success:!0,activationCode:p})}async function h(e){let t=e.id,o=e.customer?.email,r=e.status;if(a.has(t))return s.NextResponse.json({received:!0,idempotent:!0});for(let[e,s]of(a.set(t,"updated"),n.entries()))s.email===o&&s.subscriptionId===t&&(s.plan="active"===r?"premium":"downgraded",s.updatedAt=Date.now(),console.log("[Subscription] Updated:",o,"to",s.plan));return d(t,{type:"subscription.updated",id:t,customer_email:o,status:r}),s.NextResponse.json({success:!0})}async function f(e){let t=e.id,o=e.customer?.email;if(a.has(t))return s.NextResponse.json({received:!0,idempotent:!0});for(let[e,s]of(a.set(t,"canceled"),n.entries()))s.email===o&&s.subscriptionId===t&&(s.plan="expired",s.canceledAt=Date.now(),s.activated=!1,console.log("[Subscription] Canceled for:",o));return d(t,{type:"subscription.canceled",id:t,customer_email:o,status:"canceled"}),s.NextResponse.json({success:!0})}async function v(e){let t=e.id,o=e.checkout_id;if(a.has(t))return s.NextResponse.json({received:!0,idempotent:!0});for(let[e,s]of(a.set(t,"refunded"),n.entries()))s.checkoutId===o&&(s.plan="refunded",s.refundedAt=Date.now(),s.activated=!1,console.log("[Refund] Processed for checkout:",o));return d(t,{type:"refund.created",id:t,checkout_id:o,amount:e.amount,currency:e.currency}),s.NextResponse.json({success:!0})}async function g(e){let t=Date.now();try{let o,n;let a=process.env.POLAR_WEBHOOK_SECRET,i=process.env.POLAR_ACCESS_TOKEN,c=e.headers.get("polar-signature"),u=await e.text();if(a&&c){if(!function(e,t,o){if(!e||!o)return console.log("[Webhook] Missing signature or secret"),!1;let s=e.split(","),n="",a="";for(let e of s)e.startsWith("t=")&&(n=e.slice(2)),e.startsWith("v1=")&&(a=e.slice(2));if(!n||!a)return console.log("[Webhook] Invalid signature format"),!1;let i=Math.floor(Date.now()/1e3);if(Math.abs(i-parseInt(n))>300)return console.log("[Webhook] Timestamp too old, possible replay attack"),!1;let c=`${n}.${t}`,u=(0,r.createHmac)("sha256",o).update(c).digest("hex");if(a.length!==u.length)return!1;let d=0;for(let e=0;e<a.length;e++)d|=a.charCodeAt(e)^u.charCodeAt(e);return 0===d}(c,u,a))return console.log("[Webhook] Invalid signature"),s.NextResponse.json({error:"Invalid signature"},{status:401})}else console.log("[Webhook] WARNING: No webhook secret configured - skipping verification");try{o=JSON.parse(u)}catch{return s.NextResponse.json({error:"Invalid JSON"},{status:400})}let d=o.type,l=o.data;switch(console.log(`[Webhook] Processing: ${d} (${l?.id})`),d){case"checkout.completed":n=await p(l,i);break;case"subscription.created":n=await m(l,i);break;case"subscription.updated":n=await h(l);break;case"subscription.canceled":n=await f(l);break;case"refund.created":case"refund.succeeded":n=await v(l);break;default:console.log(`[Webhook] Unknown event: ${d}`),n=s.NextResponse.json({received:!0,skipped:!0})}let g=Date.now()-t;return console.log(`[Webhook] Completed ${d} in ${g}ms`),n}catch(e){return console.error("[Webhook] ERROR:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[276,972],()=>o(5351));module.exports=s})();