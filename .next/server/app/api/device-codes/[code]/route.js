"use strict";(()=>{var e={};e.id=70,e.ids=[70],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},34659:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>h,patchFetch:()=>f,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l});var s={};o.r(s),o.d(s,{GET:()=>u});var r=o(49303),n=o(88716),a=o(60670),i=o(87070),c=o(63009);async function u(e,{params:t}){let{code:o}=t||{};if(!o)return i.NextResponse.json({error:"Code is required"},{status:400});let s=String(o).toUpperCase(),r=c.deviceCodes.get(s);return r?Date.now()>r.expiresAt?(c.deviceCodes.delete(s),i.NextResponse.json({error:"Code has expired"},{status:410})):i.NextResponse.json({code:s,activated:r.activated,expiresAt:r.expiresAt,...r.activated&&r.token?{token:r.token,tokenExpiresAt:Date.now()+2592e6}:{}}):i.NextResponse.json({error:"Invalid or expired code"},{status:404})}let d=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/device-codes/[code]/route",pathname:"/api/device-codes/[code]",filename:"route",bundlePath:"app/api/device-codes/[code]/route"},resolvedPagePath:"/Users/ky/power-benchmarking-week2/app/api/device-codes/[code]/route.js",nextConfigOutput:"",userland:s}),{requestAsyncStorage:p,staticGenerationAsyncStorage:l,serverHooks:m}=d,h="/api/device-codes/[code]/route";function f(){return(0,a.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}},63009:(e,t,o)=>{o.r(t),o.d(t,{POST:()=>g,deviceCodes:()=>n,processedEvents:()=>a,purchaseRecords:()=>i});var s=o(87070),r=o(84770);let n=new Map,a=new Map,i=new Map;function c(){let e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",t="";for(let o=0;o<8;o++)4===o&&(t+="-"),t+=e.charAt(Math.random()*e.length);return t}function u(){return"pbs_"+(0,r.randomBytes)(32).toString("hex")}function d(e,t){let o={eventId:e,type:t.type,customerEmail:t.customer_email||t.customer?.email,checkoutId:t.id,productName:t.product?.name,amount:t.amount,currency:t.currency,status:t.status,processedAt:new Date().toISOString()};return i.set(e,o),console.log("[Purchase] Stored record:",e,t.type),o}async function p(e,t){if(!e||!t)return!1;try{let o=await fetch(`https://api.polar.sh/v1/subscriptions/${e}`,{headers:{Authorization:`Bearer ${t}`,Accept:"application/json"},timeout:1e4});if(!o.ok)return console.log("[Verify] Failed to verify subscription:",o.status),!1;let s=await o.json();return"active"===s.status}catch(e){return console.log("[Verify] Error verifying subscription:",e.message),!1}}async function l(e,t){let o=e.id,r=e.customer_email||e.customer?.email,i=e.product?.name||"Premium";if(a.has(o))return console.log("[Checkout] Already processed:",o),s.NextResponse.json({received:!0,idempotent:!0,existingCode:a.get(o)});if(!r)return console.log("[Checkout] No customer email, skipping"),s.NextResponse.json({error:"No customer email"},{status:400});if("completed"!==e.status&&"paid"!==e.status)return console.log("[Checkout] Payment not completed:",e.status),s.NextResponse.json({received:!0,skipped:!0,reason:`Payment status: ${e.status}`});let p=c(),l=u(),m=Date.now()+9e5;n.set(p,{email:r,plan:"premium",expiresAt:m,activated:!1,activatedAt:null,token:l,checkoutId:o,productName:i,subscriptionId:e.subscription_id}),a.set(o,p),d(o,{type:"checkout.completed",id:o,customer_email:r,product:{name:i},amount:e.amount,currency:e.currency,status:e.status,subscription_id:e.subscription_id}),console.log("[Checkout] Created activation:",p,"for",r);try{let e="https://power-benchmarking-week2.vercel.app/",t=`${e}/activate?code=${p}`;await fetch(`${e}/api/send-activation-email`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:r,code:p,activationUrl:t,productName:i})})}catch(e){console.log("[Checkout] Email send failed:",e.message)}return s.NextResponse.json({success:!0,checkoutId:o,activationCode:p,message:"Activation code created and email sent"})}async function m(e,t){let o=e.id,r=e.customer?.email;if(a.has(o))return s.NextResponse.json({received:!0,idempotent:!0});if(!r)return s.NextResponse.json({received:!0});let i=await p(o,t);if(!i&&"active"!==e.status)return console.log("[Subscription] Not active, skipping"),s.NextResponse.json({received:!0,skipped:!0});let l=c(),m=u();return n.set(l,{email:r,plan:i?"premium":"trial",expiresAt:Date.now()+9e5,activated:!1,activatedAt:null,token:m,subscriptionId:o,productName:e.product?.name}),a.set(o,l),d(o,{type:"subscription.created",id:o,customer_email:r,product:e.product,status:e.status}),console.log("[Subscription] Created for",r,":",l),s.NextResponse.json({success:!0,activationCode:l})}async function h(e){let t=e.id,o=e.customer?.email,r=e.status;if(a.has(t))return s.NextResponse.json({received:!0,idempotent:!0});for(let[e,s]of(a.set(t,"updated"),n.entries()))s.email===o&&s.subscriptionId===t&&(s.plan="active"===r?"premium":"downgraded",s.updatedAt=Date.now(),console.log("[Subscription] Updated:",o,"to",s.plan));return d(t,{type:"subscription.updated",id:t,customer_email:o,status:r}),s.NextResponse.json({success:!0})}async function f(e){let t=e.id,o=e.customer?.email;if(a.has(t))return s.NextResponse.json({received:!0,idempotent:!0});for(let[e,s]of(a.set(t,"canceled"),n.entries()))s.email===o&&s.subscriptionId===t&&(s.plan="expired",s.canceledAt=Date.now(),s.activated=!1,console.log("[Subscription] Canceled for:",o));return d(t,{type:"subscription.canceled",id:t,customer_email:o,status:"canceled"}),s.NextResponse.json({success:!0})}async function v(e){let t=e.id,o=e.checkout_id;if(a.has(t))return s.NextResponse.json({received:!0,idempotent:!0});for(let[e,s]of(a.set(t,"refunded"),n.entries()))s.checkoutId===o&&(s.plan="refunded",s.refundedAt=Date.now(),s.activated=!1,console.log("[Refund] Processed for checkout:",o));return d(t,{type:"refund.created",id:t,checkout_id:o,amount:e.amount,currency:e.currency}),s.NextResponse.json({success:!0})}async function g(e){let t=Date.now();try{let o,n;let a=process.env.POLAR_WEBHOOK_SECRET,i=process.env.POLAR_ACCESS_TOKEN,c=e.headers.get("polar-signature"),u=await e.text();if(a&&c){if(!function(e,t,o){if(!e||!o)return console.log("[Webhook] Missing signature or secret"),!1;let s=e.split(","),n="",a="";for(let e of s)e.startsWith("t=")&&(n=e.slice(2)),e.startsWith("v1=")&&(a=e.slice(2));if(!n||!a)return console.log("[Webhook] Invalid signature format"),!1;let i=Math.floor(Date.now()/1e3);if(Math.abs(i-parseInt(n))>300)return console.log("[Webhook] Timestamp too old, possible replay attack"),!1;let c=`${n}.${t}`,u=(0,r.createHmac)("sha256",o).update(c).digest("hex");if(a.length!==u.length)return!1;let d=0;for(let e=0;e<a.length;e++)d|=a.charCodeAt(e)^u.charCodeAt(e);return 0===d}(c,u,a))return console.log("[Webhook] Invalid signature"),s.NextResponse.json({error:"Invalid signature"},{status:401})}else console.log("[Webhook] WARNING: No webhook secret configured - skipping verification");try{o=JSON.parse(u)}catch{return s.NextResponse.json({error:"Invalid JSON"},{status:400})}let d=o.type,p=o.data;switch(console.log(`[Webhook] Processing: ${d} (${p?.id})`),d){case"checkout.completed":n=await l(p,i);break;case"subscription.created":n=await m(p,i);break;case"subscription.updated":n=await h(p);break;case"subscription.canceled":n=await f(p);break;case"refund.created":case"refund.succeeded":n=await v(p);break;default:console.log(`[Webhook] Unknown event: ${d}`),n=s.NextResponse.json({received:!0,skipped:!0})}let g=Date.now()-t;return console.log(`[Webhook] Completed ${d} in ${g}ms`),n}catch(e){return console.error("[Webhook] ERROR:",e),s.NextResponse.json({error:"Internal server error"},{status:500})}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),s=t.X(0,[276,972],()=>o(34659));module.exports=s})();